services:
  fcp-sfd-object-processor:
    build:
      target: development
    image: fcp-sfd-object-processor-development
    container_name: fcp-sfd-object-processor-development
    depends_on:
      localstack:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    volumes:
      - ./src/:/home/node/src
      - ./package.json:/home/node/package.json
    environment:
      NODE_ENV: development
      LOCALSTACK_ENDPOINT: http://localstack:4566
      MONGO_URI: mongodb://mongodb:27017/?replicaSet=rs0
      MONGO_READ_PREFERENCE: primary 
      CDP_UPLOADER_URL: ${CDP_UPLOADER_URL:-http://cdp-uploader:7337}
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      AWS_S3_FORCE_PATH_STYLE: true
      DOCUMENT_UPLOAD_EVENTS_TOPIC_ARN: arn:aws:sns:eu-west-2:000000000000:fcp_sfd_object_processor_events
      S3_ENDPOINT: http://localhost:4566
      SNS_ENDPOINT: http://localstack:4566
    networks:
      - fcp-sfd

  redis:
    image: redis:7.2.3-alpine3.18
    restart: always
    networks:
      - fcp-sfd

  cdp-uploader:
    image: defradigital/cdp-uploader:latest
    depends_on:
      localstack:
        condition: service_healthy
    env_file:
      - 'compose/aws.env'
    environment:
      VIRTUAL_HOST: ~^uploader\..*\.sslip\.io
      VIRTUAL_PATH: /
      VIRTUAL_PORT: 7337
      PORT: 7337
      NODE_ENV: development
      REDIS_HOST: redis
      USE_SINGLE_INSTANCE_CACHE: true
      MOCK_VIRUS_SCAN_ENABLED: true
      MOCK_VIRUS_RESULT_DELAY: 3
      SQS_ENDPOINT: http://localstack:4566
      S3_ENDPOINT: http://localstack:4566
      CONSUMER_BUCKETS: fcp-sfd-object-processor-bucket
    networks:
      - fcp-sfd
  
  localstack:
    image: localstack/localstack:3.0.2
    env_file:
      - 'compose/aws.env'
    environment:
      DEBUG: ${DEBUG:-1}
      LS_LOG: WARN # Localstack DEBUG Level
      SERVICES: s3,sqs,sns,firehose
      LOCALSTACK_HOST: 127.0.0.1
    volumes:
      - '${TMPDIR:-/tmp}/localstack:/var/lib/localstack'
      - ./compose/start-localstack.sh:/etc/localstack/init/ready.d/start-localstack.sh
    healthcheck:
      test: ['CMD', 'curl', 'localhost:4566']
      interval: 5s
      start_period: 5s
      retries: 3
    networks:
      - fcp-sfd

  mongodb:
    image: mongo:7.0.24
    command: --replSet rs0 --bind_ip_all --port 27017
    attach: false
    healthcheck:
      test: test $$(mongosh --port 27017 --quiet --eval "try {rs.initiate({_id:'rs0',members:[{_id:0,host:\"mongodb:27017\"}]})} catch(e) {rs.status().ok}") -eq 1
      interval: 10s
      start_period: 10s
    networks:
      - fcp-sfd
    volumes:
      - mongodb-data:/data
    restart: always

volumes:
  mongodb-data:

networks:
  fcp-sfd:
    driver: bridge